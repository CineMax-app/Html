<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    
    <title>MovieMax (JSON Database)</title>
    <!-- FUENTE MANROPE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- SWIPER CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <style>
        :root { --background-color: #000; --card-placeholder-color: #1f1f1f; --text-color: #fff; --text-secondary-color: #aaa; --primary-color: #E50914; --success-color: #28a745; --error-color: #dc3545; --info-color: #17a2b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; position: relative; }
        body { font-family: 'Manrope', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        a { color: inherit; text-decoration: none; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-color); opacity: 0; visibility: hidden; transform: translateX(15px); transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, transform 0.3s ease-in-out; z-index: 1; display: flex; flex-direction: column; }
        .view.active { opacity: 1; visibility: visible; transform: translateX(0); z-index: 10; }
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; width: calc(100% - 40px); max-width: 400px; }
        .toast { display: flex; align-items: center; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); color: #fff; font-size: 0.9rem; font-weight: 500; opacity: 0; transform: translateY(20px); animation: toast-in 0.5s forwards; width: 100%; }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--error-color); } .toast.info { background-color: var(--info-color); }
        .toast .material-symbols-outlined { margin-right: 10px; font-size: 22px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; background-color: #000; position: sticky; top: 0; z-index: 1000; flex-shrink: 0; }
        .header-nav { display: flex; align-items: center; gap: 1.5rem; }
        .nav-icon { font-size: 28px; cursor: pointer; color: var(--text-color); }
        .main-header .header-logo img { height: 48px; width: auto; vertical-align: middle; }
        .main-header .nav-menu-trigger { display: flex; align-items: center; gap: .3rem; font-size: 1rem; font-weight: 500; cursor: pointer; }
        #telegram-trigger { display: flex; align-items: center; justify-content: center; }
        #telegram-trigger svg { height: 24px; fill: var(--text-color); }
        .content-view-header { display: flex; align-items: center; justify-content: space-between; }
        .content-view-header-main { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .content-view-header .back-btn { font-size: 28px; cursor: pointer; }
        .content-view-header .header-title { font-weight: 600; font-size: 1.2rem; }
        #category-filter-trigger { background: none; border: none; color: var(--text-color); display: flex; align-items: center; gap: .3rem; font-size: 1rem; font-weight: 500; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: background-color .2s; flex-shrink: 0; }
        #category-filter-trigger:hover { background-color: var(--card-placeholder-color); }
        .search-header { gap: 1rem; }
        .search-bar-container { position: relative; flex-grow: 1; display: flex; align-items: center; }
        .search-bar-container .material-symbols-outlined { position: absolute; left: 12px; font-size: 24px; color: var(--text-secondary-color); pointer-events: none; }
        #search-input { width: 100%; background-color: #333; border: none; border-radius: 8px; padding: .75rem .75rem .75rem 45px; color: var(--text-color); font-size: 1rem; font-family: 'Manrope', sans-serif; }
        #search-input:focus { outline: 0; }
        main, .content-grid, .notifications-list, .profile-view-content, #channels-content, #events-content { flex-grow: 1; overflow-y: auto; padding: 0 1.25rem; }
        .homepage-content { padding: 0 1.25rem; }
        .hero-slider-container { width: 100%; aspect-ratio: 2/3; border-radius: 12px; margin-top: .5rem; margin-bottom: 2.5rem; overflow: hidden; position: relative; background-color: var(--card-placeholder-color); }
        .movies-section { margin-bottom: 1.5rem; margin-left: -1.25rem; margin-right: -1.25rem; }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; padding: 0 1.25rem; }
        .section-loader-svg { width: 28px; height: 28px; animation: rotate 2s linear infinite; display: block; margin: 0 0 1rem 1.25rem; }
        .section-loader-svg .path { stroke: var(--text-secondary-color); stroke-linecap: round; animation: dash 1.5s ease-in-out infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash { 0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; } 50% { stroke-dasharray: 90, 150; stroke-dashoffset: -35; } 100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; } }
        .movies-container { display: flex; gap: .3rem; overflow-x: auto; padding-bottom: 1rem; padding-left: 1.25rem; padding-right: 1.25rem; }
        .movies-container::-webkit-scrollbar { display: none; }
        .movies-container .card-portrait { flex: 0 0 calc((100vw - 1.0rem) / 3); }
        .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: .5rem; padding: 1rem 1.25rem; align-content: start; }
        .content-grid .card-portrait { width: 100%; }
        .movie-card-placeholder, .swiper-slide a { position: relative; display: block; }
        .movie-card-placeholder { overflow: hidden; border-radius: 5px; background-color: var(--card-placeholder-color); width: 100%; aspect-ratio: 2/3.0; }
        .content-tag { position: absolute; top: 8px; left: 8px; background-color: var(--primary-color); color: var(--text-color); padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; z-index: 3; text-transform: uppercase; }
        .movie-card-placeholder img, .swiper-slide img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .movie-card-placeholder.loaded img, .swiper-slide.loaded img { opacity: 1; }
        .swiper-slide { width: 100%; height: 100%; background-color: var(--card-placeholder-color); position: relative; overflow: hidden; }

        .shimmer-bg { position: relative; overflow: hidden; }
        .shimmer-bg::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(100deg, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0) 80%);
            transform: translateX(-100%);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        
        #channels-content, #events-content { padding-top: 1rem; }
        .tv-section { margin-bottom: 2rem; }
        .tv-section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; }
        .tv-cards-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .tv-thumbnail-container { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; background-color: var(--card-placeholder-color); margin-bottom: 0.5rem; }
        .tv-thumbnail-container img { width: 100%; height: 100%; object-fit: contain; display: block; opacity: 0; transition: opacity .5s; }
        .tv-thumbnail-container.loaded img { opacity: 1; }
        .tv-status-tag { position: absolute; bottom: 8px; left: 8px; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; z-index: 3; }
        .tv-status-tag.live { background-color: #ff0000; color: white; }
        .tv-status-tag.upcoming { background-color: #007bff; color: white; }
        .tv-status-tag.live::before { content: 'âš¡'; margin-right: 4px; }
        .tv-info .status-line { font-size: 0.8rem; color: var(--text-secondary-color); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tv-info .tv-title { font-size: 0.9rem; font-weight: 500; color: var(--text-color); line-height: 1.3; }
        .tv-info .tv-description { font-size: 0.85rem; color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .7); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease; }
        .modal.is-active { opacity: 1; visibility: visible; }
        .modal.is-active .modal-content { transform: scale(1); }
        .modal-content { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; transform: scale(.95); transition: transform .3s ease; text-align: center; }
        #home-modal .modal-content, #category-filter-modal .modal-content { background-color: transparent; padding: 0; gap: 2rem; }
        .modal-link { color: var(--text-color); text-decoration: none; font-size: 1.5rem; font-weight: 400; }
        .modal-close-btn { background: var(--card-placeholder-color); border: none; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-top: 1rem; }
        #telegram-modal .modal-content { background-color: #1f1f1f; padding: 2rem; border-radius: 16px; max-width: 320px; width: 90%; }
        #telegram-modal h3 { font-size: 1.2rem; margin: 0; }
        #telegram-modal p { color: var(--text-secondary-color); margin: 0; }
        .modal-actions { display: flex; gap: 1rem; width: 100%; }
        .modal-actions .btn { flex: 1; justify-content: center; border-radius: 50px; padding: 10px 18px; font-weight: 600; border: none; cursor: pointer; }
        .btn.primary { background-color: var(--primary-color); color: var(--text-color); }
        .btn.secondary { background-color: #333; color: var(--text-color); }
        .profile-view-content { padding: 2rem 1.25rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .profile-option { display: flex; align-items: center; gap: 1rem; font-size: 1.1rem; width: 100%; cursor: pointer; padding: .5rem 0; }
        #adsterra-profile-ad-container { margin-top: 2rem; padding-bottom: 1rem; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .notifications-list { list-style: none; padding: 1rem 1.25rem; }
        .notification-item a { display: block; color: inherit; text-decoration: none; }
        .notification-item-content { background-color: var(--card-placeholder-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; transition: background-color .2s; }
        .notification-item a .notification-item-content:hover { background-color: #333; }
        .notification-item-content h3 { margin: 0 0 .5rem; font-size: 1.1rem; }
        .notification-item-content p { margin: 0; color: var(--text-secondary-color); font-size: .9rem; }
        .notification-item-content small { display: block; text-align: right; font-size: .8rem; opacity: .6; margin-top: 1rem; }

        /* --- NUEVA MEDIA QUERY PARA RESPONSIVIDAD DEL SLIDER --- */
        @media (min-width: 768px) {
            .hero-slider-container {
                aspect-ratio: 16 / 9;
                border-radius: 16px;
                margin-bottom: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- ========= VISTAS DE LA APLICACIÃ“N ========= -->
    <div id="homepage-view" class="view active">
        <header class="header main-header">
            <div class="header-logo">
                <img src="https://i.postimg.cc/66RjCLYh/20250803-014741.png" alt="MovieMax Logo">
            </div>
            <nav class="header-nav">
                <div class="nav-menu-trigger" id="home-menu-trigger"><span class="material-symbols-outlined">arrow_drop_down</span> <span>Inicio</span></div>
                <span id="telegram-trigger" class="nav-icon"><svg viewBox="0 0 24 24" height="24" width="24"><path fill="currentColor" d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.5.71L12.6 16.3l-1.99 1.93c-.23.23-.42.42-.83.42z"></path></svg></span>
                <span class="nav-icon material-symbols-outlined search-trigger">search</span>
                <div id="header-settings-icon" class="nav-icon settings-icon"><span class="material-symbols-outlined">settings</span></div>
            </nav>
        </header>
        <main class="homepage-content">
            <div class="hero-slider-container swiper">
                <div class="swiper-wrapper"></div>
            </div>
            <section class="movies-section" id="agregados-recientes"><h2 class="section-title" style="display: none;">Agregados Recientes</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="tendencias"><h2 class="section-title" style="display: none;">Tendencias</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="accion"><h2 class="section-title" style="display: none;">AcciÃ³n</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="comedia"><h2 class="section-title" style="display: none;">Comedia</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="aventura"><h2 class="section-title" style="display: none;">Aventura</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="terror"><h2 class="section-title" style="display: none;">Terror</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="estrenos"><h2 class="section-title" style="display: none;">Estrenos</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="series"><h2 class="section-title" style="display: none;">Series</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
            <section class="movies-section" id="peliculas"><h2 class="section-title" style="display: none;">PelÃ­culas</h2><svg class="section-loader-svg" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg><div class="movies-container"></div></section>
        </main>
    </div>
    <div id="channels-view" class="view">
        <header class="header content-view-header">
            <div class="content-view-header-main"><span class="back-btn material-symbols-outlined">arrow_back</span><span class="header-title">Canales</span></div>
            <nav class="header-nav"><span class="nav-icon material-symbols-outlined search-trigger">search</span><div class="nav-icon settings-icon"><span class="material-symbols-outlined">settings</span></div></nav>
        </header>
        <main id="channels-content"></main>
    </div>
    <div id="events-view" class="view">
        <header class="header content-view-header">
            <div class="content-view-header-main"><span class="back-btn material-symbols-outlined">arrow_back</span><span class="header-title">Eventos & Directos</span></div>
            <nav class="header-nav"><span class="nav-icon material-symbols-outlined search-trigger">search</span><div class="nav-icon settings-icon"><span class="material-symbols-outlined">settings</span></div></nav>
        </header>
        <main id="events-content"></main>
    </div>
    <div id="category-view" class="view">
        <header class="header content-view-header">
            <div class="content-view-header-main"><span class="back-btn material-symbols-outlined">arrow_back</span><span class="header-title"></span></div>
            <button id="category-filter-trigger"><span>CategorÃ­as</span><span class="material-symbols-outlined">arrow_drop_down</span></button>
        </header>
        <div class="content-grid"></div>
    </div>
    <div id="my-list-view" class="view">
        <header class="header content-view-header">
            <div class="content-view-header-main"><span class="back-btn material-symbols-outlined">arrow_back</span><span class="header-title">Mi Lista</span></div>
            <nav class="header-nav"><span class="nav-icon material-symbols-outlined search-trigger">search</span><div class="nav-icon settings-icon"><span class="material-symbols-outlined">settings</span></div></nav>
        </header>
        <div class="content-grid"></div>
        <p id="empty-list-message" style="display:none;text-align:center;padding:2rem;">Tu lista estÃ¡ vacÃ­a.</p>
    </div>
    <div id="search-view" class="view">
        <header class="header search-header">
            <span class="back-btn material-symbols-outlined">arrow_back</span>
            <div class="search-bar-container"><span class="material-symbols-outlined">search</span><input type="text" id="search-input" placeholder="Buscar pelÃ­culas o series..."></div>
        </header>
        <div class="content-grid" id="search-results-container"></div>
        <p id="empty-search-message" style="display:none;text-align:center;padding:2rem;">No se encontraron resultados.</p>
    </div>
    <div id="settings-view" class="view">
        <header class="header content-view-header">
            <div class="content-view-header-main"><span class="back-btn material-symbols-outlined">arrow_back</span><span class="header-title">Ajustes</span></div>
        </header>
        <main class="profile-view-content">
            <div id="notifications-btn" class="profile-option"><span class="material-symbols-outlined">notifications</span><span>Notificaciones</span></div>
            <div class="profile-option"><span class="material-symbols-outlined">android</span><span>VersiÃ³n 1.0</span></div>
            <div id="adsterra-profile-ad-container"></div>
        </main>
    </div>
    <div id="notifications-view" class="view">
        <header class="header content-view-header">
            <div class="content-view-header-main"><span class="back-btn material-symbols-outlined">arrow_back</span><span class="header-title">Notificaciones</span></div>
        </header>
        <ul id="notifications-list" class="notifications-list"></ul>
    </div>
    
    <div class="modal" id="home-modal">
        <div class="modal-content">
            <a href="#" class="modal-link" data-type="events">Eventos & Directos</a> 
            <a href="#" class="modal-link" data-type="channels">Canales</a> 
            <a href="#" class="modal-link" data-type="movie">PelÃ­culas</a> 
            <a href="#" class="modal-link" data-type="series">Series</a> 
            <a href="#" class="modal-link" data-type="my-list">Mi Lista</a>
            <button class="modal-close-btn" data-target-modal="home-modal"><span class="material-symbols-outlined">close</span></button>
        </div>
    </div>
    <div class="modal" id="category-filter-modal"><div class="modal-content"></div></div>
    <div class="modal" id="telegram-modal"><div class="modal-content"><h3>Ãšnete al Grupo</h3><p>Te vamos a redirigir a nuestro grupo de Telegram. PodrÃ¡s pedir tu pelÃ­cula o serie favorita.</p><div class="modal-actions"><button id="telegram-cancel-btn" class="btn secondary">Cancelar</button><a href="https://t.me/FireGogrupo" target="_blank" id="telegram-confirm-btn" class="btn primary">Unirse</a></div></div></div>
    
    <div id="toast-container" class="toast-container"></div>

    <!-- SWIPER JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            
            const fetchJson = (url, defaultValue) => fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Error al cargar ${url}: ${response.statusText}`);
                    return response.json();
                })
                .catch(error => {
                    console.error(error);
                    showToast(`No se pudo cargar: ${url}`, "error");
                    return defaultValue;
                });

            try {
                const [content, notifications, sliderItems, trendingItems, channels, events] = await Promise.all([
                    fetchJson('data/content.json', []),
                    fetchJson('data/notifications.json', []),
                    fetchJson('data/slider_items.json', []),
                    fetchJson('data/trending_items.json', []),
                    fetchJson('data/channels.json', []),
                    fetchJson('data/events.json', [])
                ]);

                const db = {
                    content: content || [],
                    notifications: (notifications || []).sort((a, b) => b.timestamp - a.timestamp),
                    sliderItems: sliderItems || [],
                    trendingItems: trendingItems || [],
                    channels: channels || [],
                    events: events || []
                };
                
                runApp(db);

            } catch (error) {
                console.error("Error al cargar los archivos JSON.", error);
                showToast("Error crÃ­tico al cargar datos. Intenta refrescar la pÃ¡gina.", "error");
            }

            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = 'info';
                if (type === 'success') icon = 'check_circle';
                if (type === 'error') icon = 'error';
                toast.innerHTML = `<span class="material-symbols-outlined">${icon}</span> ${message}`;
                container.appendChild(toast);
                const style = document.createElement('style');
                style.innerHTML = `@keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }`;
                document.head.appendChild(style);
                setTimeout(() => {
                    toast.style.animation = 'toast-out 0.5s forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            }

            function runApp(db) {
                
                function loadMonetagAds() { /* ... */ }
                function loadAdsterraProfileAd() { /* ... */ }
                
                loadMonetagAds();
                loadAdsterraProfileAd();
                
                const views = document.querySelectorAll(".view");
                let viewHistory = ["homepage-view"];
                let currentCategoryViewType = "movie";
                let currentCategoryFilter = "Todos";

                function setActiveView(viewId, isBack = false) {
                    const currentActiveView = document.querySelector(".view.active");
                    if (currentActiveView && currentActiveView.id !== viewId && !isBack) {
                        viewHistory.push(currentActiveView.id);
                    }
                    views.forEach(view => view.classList.remove("active"));
                    const newView = document.getElementById(viewId);
                    if (newView) {
                        newView.classList.add("active");
                        newView.scrollTo(0, 0);
                    }
                    if (viewId === 'notifications-view') loadNotifications();
                    if (viewId === 'channels-view') populateChannelsView();
                    if (viewId === 'events-view') populateEventsView();
                    if (viewId === 'my-list-view') populateMyListView();
                    if (viewId === 'category-view') populateCategoryView();
                }
                
                function goBack() {
                    (viewHistory.length > 1) ? setActiveView(viewHistory.pop(), true) : setActiveView("homepage-view", true);
                }

                function setupModal(triggerEl, modalEl, cancelBtnId) {
                    if (triggerEl) {
                        triggerEl.addEventListener("click", e => { e.stopPropagation(); modalEl.classList.add("is-active"); });
                    }
                    if(cancelBtnId) {
                        document.getElementById(cancelBtnId)?.addEventListener("click", () => modalEl.classList.remove("is-active"));
                    }
                    modalEl?.addEventListener("click", e => { if (e.target === modalEl) modalEl.classList.remove("is-active"); });
                }
                
                const homeModal = document.getElementById("home-modal");
                setupModal(document.getElementById("home-menu-trigger"), homeModal);
                const categoryFilterModal = document.getElementById("category-filter-modal");
                setupModal(document.getElementById("category-filter-trigger"), categoryFilterModal);
                const telegramModal = document.getElementById("telegram-modal");
                setupModal(document.getElementById("telegram-trigger"), telegramModal, "telegram-cancel-btn");
                document.getElementById("telegram-confirm-btn")?.addEventListener("click", () => telegramModal.classList.remove("is-active"));

                function createCard(item) {
                    const page = item.type === 'movie' ? 'peliculas.html' : 'series.html';
                    const poster = item.poster_path || '';
                    const tagHtml = item.tag ? `<span class="content-tag">${item.tag}</span>` : '';
                    return `<div class="card-portrait">
                                <a href="${page}?id=${item.id}" class="movie-card-placeholder shimmer-bg">
                                    ${tagHtml}
                                    <img src="${poster}" alt="${item.title}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('shimmer-bg');">
                                </a>
                            </div>`;
                }

                function populateCategoryView() {
                    const contentForType = db.content.filter(item => item.type === currentCategoryViewType).reverse();
                    const titleEl = document.querySelector("#category-view .header-title");
                    const titleBase = currentCategoryViewType === 'movie' ? 'PelÃ­culas' : 'Series';
                    if (titleEl) titleEl.textContent = currentCategoryFilter === 'Todos' ? titleBase : `${titleBase} - ${currentCategoryFilter}`;
                    const gridEl = document.querySelector("#category-view .content-grid");
                    const filteredData = currentCategoryFilter === 'Todos' ? contentForType : contentForType.filter(item => (item.category || "").includes(currentCategoryFilter));
                    if (gridEl) gridEl.innerHTML = filteredData.length > 0 ? filteredData.map(createCard).join("") : `<p style="text-align:center; padding: 2rem; grid-column: 1 / -1;">No hay contenido en esta categorÃ­a.</p>`;
                }

                document.getElementById("category-filter-trigger")?.addEventListener("click", () => {
                    const contentForType = db.content.filter(item => item.type === currentCategoryViewType);
                    const categories = ['Todos', ...new Set(contentForType.flatMap(item => (item.category || "").split(',').map(c => c.trim()).filter(Boolean)))].sort();
                    const modalContent = categoryFilterModal.querySelector(".modal-content");
                    if (modalContent) {
                        modalContent.innerHTML = `${categories.map(cat => `<a href="#" class="modal-link" data-category="${cat}">${cat}</a>`).join("")} <button class="modal-close-btn"><span class="material-symbols-outlined">close</span></button>`;
                        modalContent.querySelector(".modal-close-btn")?.addEventListener("click", () => categoryFilterModal.classList.remove("is-active"));
                    }
                });

                categoryFilterModal?.addEventListener("click", e => {
                    if (e.target.classList.contains("modal-link")) { e.preventDefault(); currentCategoryFilter = e.target.dataset.category; populateCategoryView(); categoryFilterModal.classList.remove("is-active"); }
                });

                function loadHomepageContent() {
                    const swiperContainer = document.querySelector(".hero-slider-container");
                    const swiperWrapper = swiperContainer.querySelector(".swiper-wrapper");
                    const sliderContent = db.sliderItems.map(id => db.content.find(item => item.id === id)).filter(Boolean);
                    
                    if (sliderContent.length > 0 && swiperWrapper) {
                        const highRes = "https://image.tmdb.org/t/p/original", lowRes = "https://image.tmdb.org/t/p/w500";
                        swiperWrapper.innerHTML = sliderContent.map(item => {
                            const page = item.type === 'movie' ? 'peliculas.html' : 'series.html';
                            const poster = item.poster_path.includes(lowRes) ? item.poster_path.replace(lowRes, highRes) : item.poster_path;
                            const tagHtml = item.tag ? `<span class="content-tag">${item.tag}</span>` : '';
                            return `<div class="swiper-slide shimmer-bg">
                                        <a href="${page}?id=${item.id}">
                                            ${tagHtml}
                                            <img src="${poster}" alt="${item.title}" loading="lazy" onload="this.parentElement.parentElement.classList.add('loaded'); this.parentElement.parentElement.classList.remove('shimmer-bg');">
                                        </a>
                                    </div>`;
                        }).join("");

                        // InicializaciÃ³n de Swiper sin navegaciÃ³n ni paginaciÃ³n
                        new Swiper(swiperContainer, {
                            loop: sliderContent.length > 1,
                            autoplay: { delay: 4000, disableOnInteraction: false },
                            observer: true,
                            observeParents: true,
                        });
                    } else if (swiperContainer) { 
                        swiperContainer.style.display = "none"; 
                    }

                    const populateSection = (selector, data) => {
                        const section = document.querySelector(selector);
                        if (!section) return;
                        const container = section.querySelector('.movies-container'), loader = section.querySelector('.section-loader-svg'), title = section.querySelector('.section-title');
                        if (loader) loader.style.display = 'none';
                        if (data && data.length > 0) {
                            section.style.display = 'block';
                            if (title) title.style.display = 'block';
                            if (container) container.innerHTML = data.map(createCard).join("");
                        } else { section.style.display = "none"; }
                    };

                    const movies = db.content.filter(item => item.type === 'movie'), series = db.content.filter(item => item.type === 'series');
                    const currentYear = new Date().getFullYear().toString();
                    const filterContentByCategory = (category) => db.content.filter(item => item.category && item.category.toLowerCase().includes(category.toLowerCase())).reverse().slice(0, 10);
                    const trendingData = db.trendingItems.map(id => db.content.find(item => item.id === id)).filter(Boolean);

                    populateSection("#agregados-recientes", [...db.content].reverse().slice(0, 10));
                    populateSection("#tendencias", trendingData);
                    populateSection("#estrenos", db.content.filter(item => item.year === currentYear).reverse().slice(0, 10));
                    populateSection("#series", [...series].reverse().slice(0, 10));
                    populateSection("#peliculas", [...movies].reverse().slice(0, 10));
                    populateSection("#accion", filterContentByCategory('acciÃ³n'));
                    populateSection("#comedia", filterContentByCategory('comedia'));
                    populateSection("#aventura", filterContentByCategory('aventura'));
                    populateSection("#terror", filterContentByCategory('terror'));
                }
                
                function createChannelCard(item) {
                     const Tag = item.url ? 'a' : 'div';
                     const linkAttrs = item.url ? `href="${item.url}" target="_blank"` : '';
                     return `<${Tag} ${linkAttrs} class="tv-card">
                                <div class="tv-thumbnail-container shimmer-bg">
                                    <img src="${item.image}" alt="${item.title}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('shimmer-bg');">
                                    ${item.status ? `<span class="tv-status-tag ${item.status.toLowerCase()}">${item.status}</span>` : ''}
                                </div>
                                <div class="tv-info">
                                    <p class="status-line">${item.statusLine || '&nbsp;'}</p>
                                    <p class="tv-title">${item.title}</p>
                                    <p class="tv-description">${item.description || ''}</p>
                                </div>
                            </${Tag}>`;
                }

                function populateLiveView(contentEl, data, emptyMessage, cardCreator) {
                    if (!contentEl) return;
                    const items = data || [];
                    if (items.length === 0) { contentEl.innerHTML = `<p style="text-align:center; padding: 2rem;">${emptyMessage}</p>`; return; }
                    const categories = [...new Set(items.map(item => item.category || 'General'))].sort();
                    let html = '';
                    categories.forEach(category => {
                        const itemsInCategory = items.filter(item => (item.category || 'General') === category);
                        if (itemsInCategory.length > 0) html += `<div class="tv-section"><h3 class="tv-section-title">${category}</h3><div class="tv-cards-container">${itemsInCategory.map(cardCreator).join('')}</div></div>`;
                    });
                    contentEl.innerHTML = html;
                }

                function populateChannelsView() { populateLiveView(document.getElementById('channels-content'), db.channels, 'No hay canales disponibles.', createChannelCard); }
                function populateEventsView() {
                     function createEventCard(item) {
                         const Tag = item.url ? 'a' : 'div';
                         const linkAttrs = item.url ? `href="${item.url}" target="_blank"` : '';
                         return `<${Tag} ${linkAttrs} class="tv-card">
                                    <div class="tv-thumbnail-container shimmer-bg">
                                        <img src="${item.image}" alt="${item.title}" loading="lazy" onload="this.parentElement.classList.add('loaded'); this.parentElement.classList.remove('shimmer-bg');">
                                        <span class="tv-status-tag ${item.status.toLowerCase()}">${item.status}</span>
                                    </div>
                                    <div class="tv-info">
                                        <p class="status-line">${item.statusLine || '&nbsp;'}</p>
                                        <p class="tv-title">${item.title}</p>
                                        <p class="tv-description">${item.description || ''}</p>
                                    </div>
                                </${Tag}>`;
                    }
                    populateLiveView(document.getElementById('events-content'), db.events, 'No hay eventos disponibles en este momento.', createEventCard);
                }

                function loadNotifications() {
                    const listEl = document.getElementById("notifications-list");
                    if (!listEl) return;
                    if (db.notifications.length > 0) {
                        listEl.innerHTML = db.notifications.map(notif => {
                            const contentHtml = `<div class="notification-item-content"><h3>${notif.title}</h3><p>${notif.message}</p><small>${new Date(notif.timestamp).toLocaleString()}</small></div>`;
                            let link = "";
                            if (notif.contentId) {
                                const contentItem = db.content.find(item => item.id === notif.contentId);
                                if (contentItem) link = `${contentItem.type === 'movie' ? 'peliculas.html' : 'series.html'}?id=${contentItem.id}`;
                            }
                            return `<li class="notification-item">${link ? `<a href="${link}" onclick="event.preventDefault(); window.location.href='${link}';">${contentHtml}</a>` : contentHtml}</li>`;
                        }).join("");
                    } else { listEl.innerHTML = '<li style="text-align:center;padding:2rem;">No hay notificaciones.</li>'; }
                }

                document.querySelectorAll(".back-btn").forEach(btn => btn.addEventListener("click", goBack));
                document.querySelectorAll(".search-trigger").forEach(btn => btn.addEventListener("click", () => setActiveView("search-view")));
                document.querySelectorAll(".settings-icon").forEach(btn => btn.addEventListener("click", () => setActiveView("settings-view")));
                document.getElementById("notifications-btn")?.addEventListener("click", () => setActiveView("notifications-view"));
                
                homeModal?.addEventListener("click", e => {
                    if (!e.target.classList.contains("modal-link")) return;
                    e.preventDefault(); const type = e.target.dataset.type;
                    homeModal.classList.remove("is-active");
                    if (type === 'movie' || type === 'series') { currentCategoryViewType = type; currentCategoryFilter = "Todos"; setActiveView("category-view"); } 
                    else if (type === 'my-list') { setActiveView("my-list-view"); } 
                    else { setActiveView(`${type}-view`); }
                });
                homeModal?.querySelector(".modal-close-btn")?.addEventListener("click", () => homeModal.classList.remove("is-active"));

                function populateMyListView() {
                    const gridEl = document.querySelector("#my-list-view .content-grid"), emptyMsg = document.getElementById("empty-list-message");
                    const myListIds = JSON.parse(localStorage.getItem("myList") || "[]");
                    const myItems = db.content.filter(item => myListIds.includes(item.id)).reverse();
                    if(gridEl) gridEl.innerHTML = myItems.map(createCard).join("");
                    if(emptyMsg) emptyMsg.style.display = myItems.length === 0 ? "block" : "none";
                }

                document.getElementById("search-input")?.addEventListener("input", e => {
                    const query = e.target.value.toLowerCase().trim(), resultsContainer = document.getElementById("search-results-container"), emptyMsg = document.getElementById("empty-search-message");
                    if (!resultsContainer || !emptyMsg) return;
                    if (query.length < 2) { resultsContainer.innerHTML = ""; emptyMsg.style.display = "none"; return; }
                    const results = db.content.filter(item => item.title.toLowerCase().includes(query)).reverse();
                    resultsContainer.innerHTML = results.map(createCard).join("");
                    emptyMsg.style.display = results.length === 0 ? "block" : "none";
                });
                
                loadHomepageContent();
            }
        });
    </script>
</body>
</html>
